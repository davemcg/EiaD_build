---
title: "pca_workup_for_eyeIntegration_app"
author: "Prashit Parikh"
date: "2023-03-09"
output: html_document
---

```{r}
library(tidyverse)
library(matrixStats)
library(plotly)
# this file generated by scripts/pca_workup_data_prep.R
load('../data/EiaD_pca_analysis.Rdata')
emeta <- data.table::fread('../data/eyeIntegration22_meta_2023_03_03.csv.gz')
```

```{r}
do_pca <- function(gene_by_sample, meta, ntop = 1000, scale = TRUE){
  # count values for gene_by_sample
  # metadata rows must match columns of gene_by_sample
  # quick checker for data mismatch
  if (!(colnames(gene_by_sample) == meta$sample_accession) %>% sum() == ncol(gene_by_sample)){
    stop("Check metadata and matrix samples name matching")
  }
  if (scale){
    gene_by_sample <- scale(gene_by_sample)
  }
  # remove RPL/RPS/MT genes from consideration 
  keep_genes <- grep('^RPS|^RPL|^MT-|^MPRS|^MPRL',row.names(gene_by_sample),value = TRUE, invert = TRUE)
  gene_by_sample <- gene_by_sample[keep_genes,]
  Pvars <- rowVars(log2(gene_by_sample+1))
  select <- order(Pvars, decreasing = TRUE)[seq_len(min(ntop, 
                                                        length(Pvars)))]
  PCA <- prcomp(t(log2(gene_by_sample[select, ]+1)), scale = FALSE)
  percentVar <- round(100*PCA$sdev^2/sum(PCA$sdev^2),1)
  
  dataGG = cbind(PCA$x, meta)
  gene_names = PCA$rotation %>% rownames()
  out <- list(PCA, dataGG, percentVar, select, gene_names)
  out
}
```

```{r}
##################################################
# PCA time

# all minus swaroop AMD
eyeIntegration_2023_pca <- do_pca(mat_all[,(meta_mat_all %>% filter(!grepl("AMD", Perturbation)) %>% pull(sample_accession))], meta_mat_all %>% filter(!grepl("AMD", Perturbation)))

# Making files to load into eyeIntegration app

save(eyeIntegration_2023_pca, file = "../data/pca_data/eyeIntegration_2023_pca.RData")
```

#Plotting Examples

```{r}
pcFirst <- "PC1"
pcSecond <- "PC2"

ggplotly(eyeIntegration_2023_pca_with_scRNA[[2]] %>%
  filter(Source != "scRNA") %>% 
  mutate(Sub_Tissue = ifelse(Cohort == "Body", paste0(Tissue, " - ", Sub_Tissue), Sub_Tissue)) %>%
  mutate(Tissue = ifelse(Cohort == "Body", "GTEx", Tissue)) %>%
  #mutate(Tissue = ifelse(Source == "scRNA", "Single Cell RNA Samples", Tissue)) %>% 
  as_tibble() %>%
  ggplot(., aes(.data[[pcFirst]], .data[[pcSecond]])) +
  geom_point(size=3, aes(color=Tissue, shape = Source,
                         text = paste("Study: ", study_accession, "\n", "Sample: ", sample_accession, "\n",
                                      "Tissue: ", Tissue, "\n", "Sub-Tissue: ", Sub_Tissue, "\n", "Source: ", 
                                      Source, "\n", "Age: ", Age, "\n"))) +
  xlab(paste0(pcFirst, ": ",eyeIntegration_2023_pca[[3]][str_extract(pcFirst, '\\d+') %>% as.integer()],"% variance")) +
  ylab(paste0(pcSecond, ": ",eyeIntegration_2023_pca[[3]][str_extract(pcSecond, '\\d+') %>% as.integer()],"% variance")) +
  cowplot::theme_cowplot() +
  ggtitle(label = "Ocular and GTEx Sample PCA Visualization for the top 1000 protein coding genes in eyeIntegration") +
  scale_color_manual(values = c(pals::glasbey(), pals::alphabet2(), pals::alphabet2()) %>% unname()) +
  scale_fill_manual(values = c(pals::glasbey(), pals::alphabet2(), pals::alphabet2()) %>% unname()) +
  scale_shape_manual(values = 0:10), tooltip = 'text')
```