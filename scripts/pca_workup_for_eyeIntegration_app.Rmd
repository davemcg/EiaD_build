---
title: "pca_workup_for_eyeIntegration_app"
author: "Prashit Parikh"
date: "2023-05-30"
output: html_notebook:
    author: "David McGaughey"
    date: `r Sys.Date()`
    theme: flatly
    toc: true
    toc_float: true
    code_folding: hide
---

```{r}
library(tidyverse)
library(matrixStats)
library(plotly)
# this file generated by scripts/pca_workup_data_prep.R
load('../data/EiaD_pca_analysis_2023.Rdata')
# Load in file containing samples to remove from PCA analysis
excluded_samples <- scan("../data/excluded_samples.txt", what = "character")
# Load in metadata and remove excluded samples
emeta <- data.table::fread('../data/eyeIntegration22_meta_2023_03_03.csv.gz') %>% filter(!sample_accession %in% excluded_samples)
```
# Run PCA 

On **count** data which I have setup from (sc)EiaD resources in scripts/pca_workup_data_prep.R 

```{r}
##################################################
# PCA time

library(matrixStats)
library(Matrix)

do_pca <- function(gene_by_sample, meta, ntop = 1000){
  # count values for gene_by_sample
  # metadata rows must match columns of gene_by_sample
  # quick checker for data mismatch
  if (!(colnames(gene_by_sample) == meta$sample_accession) %>% sum() == ncol(gene_by_sample)){
    stop("Check metadata and matrix samples name matching")
  }
  gene_by_sample <- scale(((gene_by_sample)))
  gene_by_sample <- log1p(gene_by_sample)
  # remove RPL/RPS/MT genes from consideration 
  keep_genes <- grep('^RPS|^RPL|^MT-|^MPRS|^MPRL',row.names(gene_by_sample),value = TRUE, invert = TRUE)
  gene_by_sample <- gene_by_sample[keep_genes,]
  Pvars <- rowVars(gene_by_sample)
  select <- order(Pvars, decreasing = TRUE)[seq_len(min(ntop, 
                                                        length(Pvars)))]
  PCA <- prcomp(t((gene_by_sample[select, ])), scale = FALSE)
  percentVar <- round(100*PCA$sdev^2/sum(PCA$sdev^2),1)
  
  dataGG = cbind(PCA$x, meta)
  gene_names = PCA$rotation %>% rownames()
  out <- list(PCA, dataGG, percentVar, select, gene_names)
  out
}

# , study_accession != 'SRP273695'
mat_all_eye <- mat_all[,meta_mat_all %>% filter(Cohort == "Eye") %>% pull(sample_accession)]
mat_all_eye_meta <- meta_mat_all %>% filter(Cohort == 'Eye')

# hand run chunks below
# eye only
eye_out <- do_pca(mat_all_eye,
                  mat_all_eye_meta)
# PCA <- out[[1]]
# dataGG <- out[[2]]
# percentVar <- out[[3]]
# select <- out[[4]]

# all (including scRNA data scEiaD/plae)
#all_out <- do_pca(mat_all,meta_mat_all)
# PCA <- out[[1]]
# dataGG <- out[[2]]
# percentVar <- out[[3]]
# select <- out[[4]]

# all minus scRNA
# all
#bulk_out <- do_pca(mat_all[,(meta_mat_all %>% filter(Source != 'scRNA') %>% #pull(sample_accession))], meta_mat_all %>% filter(Source != 'scRNA') )

# all minus swaroop AMD
eyeIntegration_2023_pca <- do_pca(mat_all[,(meta_mat_all %>% filter(!grepl("AMD", Perturbation)) %>% pull(sample_accession))], meta_mat_all %>% filter(!grepl("AMD", Perturbation)) )
```

# Code to save PCA data for use in the eyeIntegration app

```{r}
#save(eyeIntegration_2023_pca, file = "../data/pca_data/eyeIntegration_2023_pca.RData")
```

# Top level look

## PC1 and PC2
```{r, fig.width=12, fig.height=8}
PCA <- eyeIntegration_2023_pca[[1]]
dataGG <- eyeIntegration_2023_pca[[2]]
percentVar <- eyeIntegration_2023_pca[[3]]
select <- eyeIntegration_2023_pca[[4]]

pcFirst <- 'PC1'
pcSecond <- 'PC2'
rotations <- c(pcFirst, pcSecond)


top_rotations <- 
  c(PCA$rotation[,str_extract(pcFirst, '\\d+') %>% as.integer()] %>% sort() %>% head(3) %>% names(),
    PCA$rotation[,str_extract(pcFirst, '\\d+') %>% as.integer()] %>% sort() %>% tail(3) %>% names(),
    PCA$rotation[,str_extract(pcSecond, '\\d+') %>% as.integer()] %>% sort() %>% head(3) %>% names(),
    PCA$rotation[,str_extract(pcSecond, '\\d+') %>% as.integer()] %>% sort() %>% tail(3) %>% names()) %>% 
  unique()

rotation_multipler_first <- dataGG[pcFirst] %>% pull(1) %>% abs() %>% max() / PCA$rotation[,str_extract(pcFirst, '\\d+') %>% as.integer()] %>% abs() %>% max()
rotation_multipler_second <- dataGG[pcSecond] %>% pull(1) %>% abs() %>% max() / PCA$rotation[,str_extract(pcSecond, '\\d+') %>% as.integer()] %>% abs() %>% max()

dataGG %>%
  #filter(Source != 'scRNA') %>% 
  as_tibble() %>% 
  mutate(Tissue = case_when(Tissue == 'Brain' ~ Tissue,
                            Cohort == 'Body' ~ 'Body',
                            TRUE ~ Tissue)) %>% 
  ggplot(., aes(.data[[pcFirst]], .data[[pcSecond]])) +
  geom_point(size=3, aes(color=Tissue, shape = Source)) +
  geom_segment(data = PCA$rotation[top_rotations,rotations] %>% data.frame(), aes(x=0,y=0, xend = .data[[pcFirst]]*rotation_multipler_first, yend = .data[[pcSecond]]*rotation_multipler_second)) +
  ggrepel::geom_label_repel(data = PCA$rotation[top_rotations,rotations] %>% 
                              as_tibble(rownames = 'Gene') %>% 
                              mutate(Gene = gsub(' \\(.*','',Gene)), 
                            aes(x=.data[[pcFirst]]*rotation_multipler_first, y = .data[[pcSecond]] * rotation_multipler_second, label = Gene)) +
  xlab(paste0(pcFirst, ": ",percentVar[str_extract(pcFirst, '\\d+') %>% as.integer()],"% variance")) +
  ylab(paste0(pcSecond, ": ",percentVar[str_extract(pcSecond, '\\d+') %>% as.integer()],"% variance")) + 
  cowplot::theme_cowplot() +
  scale_color_manual(values = c(pals::glasbey(), pals::alphabet2(), pals::alphabet2()) %>% unname()) +
  scale_fill_manual(values = c(pals::glasbey(), pals::alphabet2(), pals::alphabet2()) %>% unname()) +
  scale_shape_manual(values = 0:10) 
```
