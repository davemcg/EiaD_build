---
title: "pca_workup_eyeIntegration_app"
author: "Prashit Parikh"
date: "2023-01-05"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r, include=FALSE}
setwd("/Users/parikhpp/git_collab/EiaD_build/scripts")

library(tidyverse)
library(plotly)
# this file generated by scripts/pca_workup_data_prep.R
load('../data/EiaD_pca_analysis.Rdata')
```

# Functions

```{r}
# Functions for downstream analysis

do_pca <- function(gene_by_sample, meta){
  # TPM values for gene_by_sample
  # metadata rows must match columns of gene_by_sample
  # quick checker for data mismatch
  if (!(colnames(TPM) == tpm_meta$sample_accession) %>% sum() == ncol(TPM)){
    stop("Check metadata and matrix samples name matching")
  }
  Pvars <- rowVars(log2(gene_by_sample+1))
  select <- order(Pvars, decreasing = TRUE)[seq_len(min(ntop, 
                                                        length(Pvars)))]
  PCA <- prcomp(t(log2(gene_by_sample[select, ]+1)), scale = F)
  percentVar <- round(100*PCA$sdev^2/sum(PCA$sdev^2),1)
  
  dataGG = cbind(PCA$x, meta)
  out <- list(PCA, dataGG, percentVar, select)
  out
}

dist_processor <- function(samples_as_row_matrix, metadata){
  # row.names must be given that match `sample_accession` in metadata
  # matrix should be log2 (or whatever) normalized
  # euc_dist <- dist(t(log2(TPMall[select,]+1)), method = 'euclidean')
  if ((nrow(metadata) != nrow(samples_as_row_matrix))){
    stop("Matrix row num != metadata row num!")
  }
  if (metadata$sample_accession != row.names(samples_as_row_matrix)){
    stop("Matrix row names != metadata row names!")
  }
  euc_dist <- dist(samples_as_row_matrix, method = 'euclidean')
  euc_dist <- as.matrix(euc_dist)
  
  # metadata:
  # metadata %>% select(sample_accession, BioSample, study_accession, Cohort, Tissue,  Sub_Tissue, Source, Age) %>% unique()
  xy <- t(combn(colnames(euc_dist), 2))
  euc_dist_long <- data.frame(xy, dist=euc_dist[xy])
  colnames(euc_dist_long) <- c('sample_accession', 'against', 'dist')
  euc_dist_long_meta <- euc_dist_long %>% 
    left_join(metadata, by = 'sample_accession')
  euc_dist_long_meta
}
```

# RUN PROTEIN CODING PCA

```{r}
# PCA Data and Metadata creation

library(matrixStats)
ntop = 1000

tpm_meta <- colnames(TPM) %>% enframe(value = 'sample_accession') %>% 
  left_join(emeta %>% 
              select(sample_accession, 
                     BioSample, study_accession, Cohort, 
                     Tissue, Sub_Tissue, Source, Age) %>% unique(),
            by = 'sample_accession')

# http://duffel.rail.bio/recount3/human/new_annotations/gene_sums/human.gene_sums.G029.gtf.gz
gene_annotations <- 
  rtracklayer::import("pca_data/human.gene_sums.G029.gtf.gz") %>% 
  as.data.frame()
```

```{r}
# all minus scRNA with only protein coding genes
pc_ensgene <- gene_annotations %>% filter(gene_type == 'protein_coding') %>% pull(gene_id) %>% gsub('\\.\\d+$','',.)
pc_gene_name <- gene_annotations %>% filter(gene_type == 'protein_coding') %>% pull(gene_name) 
pc_gene_full <- paste0(pc_gene_name, ' (', pc_ensgene, ')')
out <- do_pca(TPM[pc_gene_full,], tpm_meta)
PCA <- out[[1]]
dataGG <- out[[2]]
eye_percentVar_data <- out[[3]]
select <- out[[4]]

# dist by PCA
pca_mat <- PCA$x[,1:10]
row.names(pca_mat) <- tpm_meta$sample_accession
pca_dist <- dist_processor(pca_mat,
                           tpm_meta)
```

# PROTEIN CODING GRAPHS

```{r}
# PCA based metadata

pca_dist_metadata <-
  pca_dist %>%
  # metadata for the "against" sample
  left_join(emeta %>% dplyr::select(sample_accession, 
                                    study_accession2 = study_accession, 
                                    Tissue2 = Tissue,
                                    Cohort2 = Cohort) %>% unique(), 
            by = c('against' = 'sample_accession')) %>% 
  filter(study_accession != study_accession2, 
         study_accession != 'SRP273695', # incorrectly labeled samples
         study_accession != 'SRP382853', # incorrectly labeled samples
         sample_accession != against,
         #study_accession2 != 'SRP273695',
         Cohort == 'Eye', 
         Cohort2 == 'Eye') %>% 
  as_tibble() %>% 
  group_by(sample_accession, study_accession, Tissue, Sub_Tissue, Source, Age) %>% 
  slice_min(n = 20, order_by = dist) %>%
  ungroup() %>% 
  group_by(sample_accession, study_accession, Tissue, Sub_Tissue, Source, Age, Tissue2) %>% 
  summarise(Count = n()) %>% 
  mutate(Tissue3 = paste0(Tissue2, ' (', Count,')')) %>% 
  summarise(Count = sum(Count[Tissue != Tissue2]),
            Tissue2 = paste(Tissue3, collapse = ',') )
```

```{r}
# Plotting PCA output with distance values
eye_pca_data <- dataGG %>% filter(sample_accession %in% pca_dist_metadata$sample_accession) %>%
  left_join(pca_dist_metadata %>% ungroup() %>% 
              select(-study_accession, -Tissue, -Sub_Tissue, -Source, -Age), by = c("sample_accession"))

#save(eye_pca_data, file = "pca_data/eye_pca_data.RData")
#save(eye_percentVar_data, file = "pca_data/eye_percentVar_data.RData")
```

```{r}
pcFirst <- 'PC3'
pcSecond <- 'PC4'

ggplotly(dataGG_pca %>%
  #filter(Source != 'scRNA') %>% 
  as_tibble() %>%
  ggplot(., aes(.data[[pcFirst]], .data[[pcSecond]])) +
  geom_point(size=3, aes(color=Tissue, shape = Source,
                         text = paste(study_accession, "\n", sample_accession, "\n", Tissue, "\n",
                                      Sub_Tissue, "\n", Source, "\n", Age, "\n",
                                      Count, "\n", Tissue2))) +
  xlab(paste0(pcFirst, ": ",percentVar[str_extract(pcFirst, '\\d+') %>% as.integer()],"% variance")) +
  ylab(paste0(pcSecond, ": ",percentVar[str_extract(pcSecond, '\\d+') %>% as.integer()],"% variance")) + 
  cowplot::theme_cowplot() +
  scale_color_manual(values = c(pals::glasbey(), pals::alphabet2(), pals::alphabet2()) %>% unname()) +
  scale_fill_manual(values = c(pals::glasbey(), pals::alphabet2(), pals::alphabet2()) %>% unname()) +
  scale_shape_manual(values = 0:10), tooltip = 'text')
```